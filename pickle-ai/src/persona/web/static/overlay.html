<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Persona Overlay</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: #6b7280;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .avatar.speaking {
            animation: pulse 0.8s infinite;
        }

        .avatar-face {
            font-size: 60px;
            transition: all 0.3s ease;
        }

        /* Emotion colors */
        .avatar.neutral {
            background: #6b7280;
        }

        .avatar.happy {
            background: #fbbf24;
        }

        .avatar.excited {
            background: #f97316;
        }

        .avatar.surprised {
            background: #3b82f6;
        }

        .avatar.thinking {
            background: #8b5cf6;
        }

        .avatar.laughing {
            background: #22c55e;
        }

        .emotion-label {
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 12px;
            border-radius: 12px;
            opacity: 0.8;
        }

        .status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
        }

        .status.connected {
            color: #22c55e;
        }

        .status.disconnected {
            color: #ef4444;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }
            50% {
                transform: scale(1.08);
                box-shadow: 0 4px 30px rgba(255, 255, 255, 0.2);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }
        }

        /* Emotion-specific faces */
        .avatar.neutral .avatar-face::before { content: 'üòê'; }
        .avatar.happy .avatar-face::before { content: 'üòä'; }
        .avatar.excited .avatar-face::before { content: 'ü§©'; }
        .avatar.surprised .avatar-face::before { content: 'üòÆ'; }
        .avatar.thinking .avatar-face::before { content: 'ü§î'; }
        .avatar.laughing .avatar-face::before { content: 'üòÇ'; }
    </style>
</head>
<body>
    <div class="avatar-container">
        <div id="avatar" class="avatar neutral">
            <span class="avatar-face"></span>
        </div>
        <div id="emotion-label" class="emotion-label">neutral</div>
    </div>
    <div id="status" class="status disconnected">disconnected</div>

    <script>
        const avatar = document.getElementById('avatar');
        const emotionLabel = document.getElementById('emotion-label');
        const statusEl = document.getElementById('status');

        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                statusEl.textContent = 'connected';
                statusEl.className = 'status connected';
                reconnectAttempts = 0;
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                statusEl.textContent = 'disconnected';
                statusEl.className = 'status disconnected';

                // Attempt reconnect
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                    console.log(`Reconnecting in ${delay}ms...`);
                    setTimeout(connect, delay);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    console.error('Failed to parse message:', e);
                }
            };
        }

        function handleMessage(data) {
            console.log('Received:', data);

            switch (data.type) {
                case 'init':
                    setEmotion(data.emotion || 'neutral');
                    setSpeaking(data.speaking || false);
                    break;

                case 'emotion':
                    setEmotion(data.value);
                    break;

                case 'speaking':
                    setSpeaking(data.value);
                    break;
            }
        }

        function setEmotion(emotion) {
            // Remove all emotion classes
            avatar.className = 'avatar';
            // Add new emotion class
            avatar.classList.add(emotion);
            // Update label
            emotionLabel.textContent = emotion;
        }

        function setSpeaking(speaking) {
            if (speaking) {
                avatar.classList.add('speaking');
            } else {
                avatar.classList.remove('speaking');
            }
        }

        // Start connection
        connect();
    </script>
</body>
</html>
